name: Generate Release Notes (Scheduled)

on:
  schedule:
    # Run every Monday at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:  # Allow manual triggering

jobs:
  generate-release-notes:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download Auto Release Note CLI
        run: |
          # Download from distribution repository
          VERSION="latest"
          if [ "$VERSION" == "latest" ]; then
            # Get latest release URL
            DOWNLOAD_URL=$(curl -s https://api.github.com/repos/papyrus-digital/auto-release-cli-distribution/releases/latest | grep "browser_download_url.*linux_amd64.tar.gz" | cut -d '"' -f 4)
          else
            DOWNLOAD_URL="https://github.com/papyrus-digital/auto-release-cli-distribution/releases/download/${VERSION}/arn_${VERSION}_linux_amd64.tar.gz"
          fi
          curl -LO "$DOWNLOAD_URL"
          tar -xzf arn_*_linux_amd64.tar.gz
          chmod +x arn
          sudo mv arn /usr/local/bin/

      - name: Get Date Range
        id: date_range
        run: |
          # Get date 7 days ago
          FROM_DATE=$(date -u -d '7 days ago' +%Y-%m-%d)
          TO_DATE=$(date -u +%Y-%m-%d)
          
          # Get commits from last week
          FROM_SHA=$(git log --until="$FROM_DATE" --format="%H" -n 1)
          TO_SHA=$(git rev-parse HEAD)
          
          echo "from_date=$FROM_DATE" >> $GITHUB_OUTPUT
          echo "to_date=$TO_DATE" >> $GITHUB_OUTPUT
          echo "from_sha=$FROM_SHA" >> $GITHUB_OUTPUT
          echo "to_sha=$TO_SHA" >> $GITHUB_OUTPUT

      - name: Generate Release Notes
        id: generate
        env:
          AUTO_RELEASE_TOKEN: ${{ secrets.AUTO_RELEASE_TOKEN }}
          AUTO_RELEASE_PROJECT_ID: ${{ secrets.AUTO_RELEASE_PROJECT_ID }}
        run: |
          RELEASE_URL=$(arn generate \
            --non-interactive \
            --mode commit \
            --from ${{ steps.date_range.outputs.from_sha }} \
            --to ${{ steps.date_range.outputs.to_sha }} \
            --template "Standard Changelog" \
            --output-url)
          
          echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "Release notes generated: $RELEASE_URL"

      - name: Create Draft Release
        uses: softprops/action-gh-release@v1
        if: success()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: weekly-$(date +%Y%m%d)
          name: Weekly Release Notes - ${{ steps.date_range.outputs.from_date }} to ${{ steps.date_range.outputs.to_date }}
          body: |
            ## Weekly Release Notes
            
            **Period:** ${{ steps.date_range.outputs.from_date }} to ${{ steps.date_range.outputs.to_date }}
            
            **View Full Release Notes:** [${{ steps.generate.outputs.url }}](${{ steps.generate.outputs.url }})
            
            ---
            *Automatically generated by Auto Release Note CLI*
          draft: true
          prerelease: false

      # Optional: Post to Slack/Discord
      # - name: Post to Slack
      #   uses: slackapi/slack-github-action@v1
      #   with:
      #     webhook-url: ${{ secrets.SLACK_WEBHOOK_URL }}
      #     payload: |
      #       {
      #         "text": "Weekly release notes generated!",
      #         "blocks": [{
      #           "type": "section",
      #           "text": {
      #             "type": "mrkdwn",
      #             "text": "üìù *Weekly Release Notes*\n<${{ steps.generate.outputs.url }}|View Release Notes>"
      #           }
      #         }]
      #       }

